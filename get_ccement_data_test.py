import urllib.request  
import urllib  
import gzip  
import http.cookiejar 
import types  
import time
from datetime import datetime, timedelta

def data_parser(parser_data,province_name,data_range_week):  
  
    #print(parser_data.find('[['))
    #print(parser_data.find(']],'))
    parser_data=parser_data[parser_data.find('[[')+2:parser_data.find(']],')]
    data_array=parser_data.split('],[')

    #data_array[0].strip('[')
    #data_array[len(data_array)-1].strip(']')
    #print(len(data_array))
    #print(data_array[0])
    #print(data_array[len(data_array)-1])
    #print(time.time())
    #print(float(data_array[0].split(',')[0])/1000)
    #time.gmtime(float(data_array[0].split(',')[0])/1000)
    #print (time.strftime("%Y-%m-%d %H:%M:%S", time.localtime(float(data_array[0].split(',')[0])/1000)))
    #print (time.strftime("%Y-%m-%d %H:%M:%S", float(data_array[0].split(',')[0])/1000))
    #print(data_array)
    #print(data)
    
    #print(type(time.strftime("%Y-%m-%d %H:%M:%S")))

    print('今天日期:'+time.strftime("%Y-%m-%d"))
    f = open('D:/test_data/'+time.strftime("%Y-%m-%d")+'_result.csv','a')
    f.write('省份,'+province_name+'\n')
    record_date='日期'
    record_open='本周初价格'
    record_high='本周最高'
    record_low='本周最低'
    record_close='本周末价格'
    #f.write('日期,本周初价格,本周最高,本周最低,本周末价格'+'\n')
    i=0
    #nowtime = datetime.now()

    while i < len(data_array) :
        if datetime.now() - datetime.strptime(time.strftime("%Y-%m-%d %H:%M:%S", time.localtime(float(data_array[i].split(',')[0])/1000)), '%Y-%m-%d %H:%M:%S') < timedelta(weeks=data_range_week) :
            record_date= record_date+','+time.strftime("%Y-%m-%d", time.localtime(float(data_array[i].split(',')[0])/1000))
            record_open=record_open+','+data_array[i].split(',')[1]
            record_high=record_high+','+data_array[i].split(',')[2]
            record_low=record_low+','+data_array[i].split(',')[3]
            record_close=record_close+','+data_array[i].split(',')[4]
        #print("日期 : "+record_date)
        #print("本周初价格 : "+record_open)
        #print("本周最高 : "+ record_high)
        #print("本周最低 : "+record_low)
        #print("本周末价格 : "+record_close)
  
        #f.write(record_date+','+record_open+','+record_high+','+record_low+','+record_close+'\n' )

        i+=1
    f.write(record_date+'\n')
    f.write(record_open+'\n')
    f.write(record_high+'\n')
    f.write(record_low+'\n')
    f.write(record_close+'\n')
    f.close


def main():  
    parser_data = '[[1375372800000,276.97,276.97,276.97,276.97],[1375977600000,276.97,276.97,276.97,276.97],[1376582400000,276.97,276.97,276.97,276.97],[1377187200000,276.97,276.97,276.97,276.97],[1377792000000,276.97,276.97,266.27,266.27],[1378396800000,266.27,266.27,266.27,266.27],[1379001600000,266.27,266.27,266.27,266.27],[1379433600000,266.27,266.27,266.27,266.27],[1380211200000,266.27,266.27,266.27,266.27],[1381420800000,266.27,266.27,266.27,266.27],[1382025600000,266.27,266.27,263.48,263.48],[1382630400000,263.48,265.8,263.48,265.8],[1383235200000,265.8,267,265.8,267],[1383840000000,267,280.38,267,280.38],[1384444800000,280.38,280.38,280.38,280.38],[1385049600000,280.38,280.38,280.38,280.38],[1385654400000,280.38,286.37,280.38,286.37],[1386259200000,286.37,286.37,286.37,286.37],[1386864000000,296.22,296.22,296.22,296.22],[1387468800000,296.22,296.22,296.22,296.22],[1388073600000,296.22,296.22,296.22,296.22],[1388678400000,297.25,297.25,297.25,297.25],[1389283200000,297.25,297.25,297.25,297.25],[1389888000000,297.25,297.25,284.38,284.38],[1390492800000,284.38,284.38,284.38,284.38],[1392307200000,277.15,277.15,277.15,277.15],[1392912000000,277.15,277.15,277.15,277.15],[1393430400000,277.15,277.15,277.15,277.15],[1394121600000,277.15,277.15,269.79,269.79],[1394726400000,269.79,269.79,269.79,269.79],[1395331200000,269.79,269.79,269.79,269.79],[1395936000000,269.79,269.79,269.79,269.79],[1396540800000,269.79,270.77,269.79,270.77],[1397145600000,270.77,281.46,270.77,281.46],[1397750400000,282.7,282.7,281.46,281.46],[1398355200000,281.46,281.46,281.46,281.46],[1399564800000,281.46,281.46,281.46,281.46],[1400169600000,281.46,281.46,281.46,281.46],[1400774400000,281.46,281.46,281.46,281.46],[1401379200000,281.46,281.46,281.46,281.46],[1401984000000,281.46,281.46,281.46,281.46],[1402588800000,281.46,281.46,281.46,281.46],[1403193600000,281.46,281.46,281.46,281.46],[1403798400000,281.46,281.46,281.46,281.46],[1404403200000,281.46,281.46,281.46,281.46],[1405008000000,281.46,281.46,280.48,280.48],[1405612800000,280.48,280.48,279.79,279.79],[1406217600000,278.89,278.89,277.86,277.86],[1406822400000,277.86,277.86,277.86,277.86],[1407427200000,277.86,277.86,277.86,277.86],[1408032000000,277.86,277.86,277.86,277.86],[1408636800000,277.86,277.86,276.87,276.87],[1409241600000,276.87,276.87,276.87,276.87],[1409846400000,276.87,276.87,274.41,274.41],[1410451200000,274.41,274.41,272.54,272.54],[1411056000000,272.54,272.54,272.54,272.54],[1411660800000,271.77,271.77,271.77,271.77],[1412870400000,271.77,271.77,271.77,271.77],[1413475200000,271.77,271.77,270.65,270.65],[1414080000000,270.65,270.65,270.65,270.65],[1414684800000,270.65,270.65,270.65,270.65],[1415289600000,270.65,270.65,270.65,270.65],[1415894400000,270.65,270.65,270.65,270.65],[1416499200000,270.65,276.02,270.65,276.02],[1417104000000,276.02,276.02,276.02,276.02],[1417708800000,276.02,276.02,276.02,276.02],[1418313600000,276.02,276.02,276.02,276.02],[1418918400000,276.02,276.02,256.77,256.77],[1419523200000,256.77,256.77,248.88,248.88],[1419955200000,248.88,248.88,248.88,248.88],[1420732800000,248.88,248.88,248.88,248.88],[1421337600000,248.88,248.88,248.88,248.88],[1421942400000,248.88,248.88,248.88,248.88],[1422547200000,248.88,248.88,248.88,248.88],[1423152000000,248.88,248.88,248.88,248.88],[1423756800000,248.88,248.88,248.88,248.88],[1424966400000,248.88,248.88,248.88,248.88],[1425571200000,250.12,250.12,250.12,250.12],[1426176000000,250.12,250.12,249.52,249.52],[1426780800000,249.52,249.52,249.52,249.52],[1427385600000,249.52,249.52,247.86,247.86],[1427990400000,247.86,247.86,247.86,247.86],[1428595200000,247.86,247.86,247.86,247.86],[1429200000000,247.86,247.86,247.86,247.86],[1429804800000,247.86,247.86,247.86,247.86],[1430323200000,247.86,247.86,247.86,247.86],[1431014400000,247.86,247.86,245.92,245.92],[1431619200000,245.92,245.92,245.92,245.92],[1432224000000,245.92,245.92,245.92,245.92],[1432828800000,245.92,245.92,245.92,245.92],[1433433600000,245.92,245.92,245.92,245.92],[1434038400000,238.74,238.74,238.74,238.74],[1434643200000,238.74,238.74,238.74,238.74],[1435248000000,238.74,238.74,238.74,238.74],[1435852800000,238.74,238.74,238.74,238.74],[1436457600000,238.74,238.74,238.74,238.74],[1437062400000,238.74,238.74,238.74,238.74],[1437667200000,238.74,238.74,238.74,238.74],[1438272000000,238.74,238.74,238.74,238.74],[1438876800000,238.74,238.74,235.13,235.13],[1439481600000,235.13,235.13,234.53,234.53],[1440086400000,234.53,234.53,231.73,231.73],[1440691200000,231.73,231.73,231.73,231.73],[1441123200000,232.34,232.34,232.34,232.34],[1441900800000,232.34,232.34,229.71,229.71],[1442505600000,229.71,229.71,222.21,222.21],[1443110400000,222.21,222.21,222.21,222.21],[1444320000000,222.21,222.21,222.21,222.21],[1444924800000,220.99,220.99,220.99,220.99],[1445529600000,220.99,220.99,218.91,218.91],[1446134400000,221.39,221.39,221.39,221.39],[1446739200000,221.39,226.18,221.39,226.18],[1447344000000,226.18,226.18,226.18,226.18],[1447948800000,226.18,227.39,226.18,226.98],[1448553600000,224.2,224.2,224.2,224.2],[1449158400000,224.2,224.2,224.2,224.2],[1449763200000,224.2,224.2,224.2,224.2],[1450368000000,224.2,224.2,224.2,224.2],[1450972800000,224.2,224.2,222.23,222.23],[1451491200000,222.23,222.23,222.23,222.23],[1452182400000,222.23,222.23,221.41,221.41],[1452787200000,221.41,221.41,220.81,220.81],[1453392000000,220.81,220.81,220.81,220.81],[1453996800000,220.81,220.81,220.81,220.81],[1454601600000,220.81,220.81,220.81,220.81],[1455811200000,220.81,220.81,220.81,220.81],[1456416000000,220.81,220.81,220.81,220.81],[1457020800000,220.81,220.81,220.81,220.81],[1457625600000,220.81,220.81,220.81,220.81],[1458230400000,220.81,228.2,219.41,228.2],[1458835200000,228.2,228.2,228.2,228.2],[1459440000000,228.2,228.2,225.36,225.36],[1460044800000,225.36,225.36,225.36,225.36],[1460649600000,225.36,225.36,225.36,225.36],[1461254400000,225.36,225.36,224.41,224.41],[1461859200000,225.64,230.61,225.64,230.61],[1462464000000,230.61,231.82,230.61,231.82],[1463068800000,236.72,237.91,236.72,237.91],[1463673600000,237.91,237.91,237.91,237.91],[1464278400000,237.91,237.91,237.91,237.91],[1464883200000,237.91,237.91,237.23,237.23],[1465315200000,237.23,237.23,237.23,237.23],[1466092800000,237.23,237.23,234.76,234.76],[1466697600000,234.76,234.76,228.17,228.17],[1467302400000,228.17,228.17,228.17,228.17],[1467907200000,228.17,228.17,228.17,228.17],[1468512000000,228.17,228.17,228.17,228.17],[1469116800000,228.17,228.72,225.76,228.72],[1469721600000,228.72,228.72,228.72,228.72],[1470326400000,228.72,241.69,228.72,241.69],[1470931200000,242.35,242.35,241.27,241.27],[1471536000000,241.27,241.27,241.27,241.27],[1472140800000,242.56,248.66,242.56,248.66],[1473350400000,248.66,256.42,248.66,256.42],[1473782400000,263.69,263.69,263.69,263.69],[1474560000000,263.69,263.69,258.21,258.21],[1475164800000,258.21,258.21,258.21,258.21],[1476374400000,298.67,302.77,296.62,302.77],[1476979200000,351.58,351.58,351.58,351.58],[1477497600000,428.17,428.7,428.17,428.7],[1478188800000,372.19,372.19,372.19,372.19],[1478793600000,372.19,372.27,358.65,358.65],[1479398400000,357.72,357.72,357.72,357.72],[1480003200000,357.72,357.72,357.72,357.72],[1480608000000,357.72,359.28,356.81,359.28],[1481212800000,358.42,369.28,358.42,369.28],[1481817600000,369.58,377.69,369.58,377.69],[1482422400000,377.69,377.69,377.69,377.69],[1483027200000,377.69,377.69,376.83,376.83],[1483632000000,376.83,377.34,376.83,377.34],[1484236800000,377.34,377.34,375.58,375.58],[1484841600000,375.58,375.58,375.58,375.58],[1486051200000,375.58,375.58,375.58,375.58],[1486656000000,375.58,375.58,375.58,375.58],[1487260800000,375.58,375.58,360.21,360.21],[1487865600000,360.21,360.21,360.21,360.21],[1488470400000,360.21,360.21,351.94,351.94],[1489075200000,351.94,352.64,351.94,352.64],[1489680000000,352.64,358.33,349.03,358.33],[1490284800000,358.33,358.33,358.33,358.33],[1490889600000,358.33,358.33,348.33,348.33],[1491494400000,355.54,355.54,355.54,355.54],[1492099200000,355.54,355.54,353.9,353.9],[1492704000000,353.9,353.9,353.9,353.9],[1493308800000,353.9,353.9,346.14,346.14],[1493913600000,346.14,352.56,340.56,352.56],[1494518400000,352.56,361.2,352.56,361.2],[1495123200000,363.35,363.35,359.48,359.48],[1495728000000,359.48,361.63,359.48,361.63],[1496332800000,361.63,361.63,361.63,361.63],[1496937600000,361.63,361.63,353.65,353.65],[1497542400000,353.65,354.08,353.65,354.08],[1498147200000,354.08,354.08,354.08,354.08],[1498752000000,354.08,354.08,352.19,352.19],[1499356800000,346.9,346.9,346.9,346.9],[1499961600000,345.69,345.69,338.46,338.46],[1500566400000,335.66,344.67,333.67,344.67],[1501171200000,336.49,336.49,336.49,336.49],[1501776000000,336.49,336.49,332.88,332.88],[1502380800000,332.88,332.88,327.47,328.85],[1502985600000,332.46,332.46,331.38,331.38],[1503590400000,331.38,331.88,331.38,331.88],[1504195200000,332.58,336.89,332.58,336.89],[1504800000000,336.89,354.33,336.89,354.33],[1505404800000,354.33,356.07,354.33,356.07],[1506009600000,356.07,358.74,356.07,357.87],[1506614400000,357.87,359.54,357.87,359.54],[1507824000000,359.54,359.54,358.99,358.99],[1508428800000,358.99,358.99,358.99,358.99],[1509033600000,359.42,381.74,359.42,381.74],[1509638400000,381.74,386.38,381.74,386.38],[1510243200000,408.88,412.05,408.88,412.05],[1510848000000,429.22,445.16,429.22,445.16],[1511452800000,450.8,460.07,450.8,460.07],[1512057600000,460.07,473.22,460.07,473.22],[1512662400000,491.22,505.79,491.22,505.79],[1513267200000,506.3,511.72,506.3,511.72],[1513872000000,511.72,514.14,511.72,514.14],[1514476800000,514.14,514.14,512.85,512.85],[1515081600000,519.93,519.93,519.93,519.93],[1515686400000,519.93,519.93,519.93,519.93],[1516291200000,519.93,519.93,505.23,505.23],[1516896000000,500.95,500.95,484.73,484.73],[1517500800000,484.73,484.73,484.73,484.73],[1518105600000,484.73,484.73,484.73,484.73],[1519315200000,477.83,477.83,477.83,477.83],[1519920000000,477.83,477.83,460.82,460.82],[1520524800000,457.01,457.01,457.01,457.01],[1521129600000,457.01,457.01,435.01,435.01],[1521734400000,435.01,435.01,435.01,435.01],[1522339200000,435.01,435.01,432.87,432.87],[1522771200000,432.87,432.87,432.53,432.53],[1523548800000,430.7,430.7,415.3,415.3],[1524153600000,415.3,431.64,412.87,431.64],[1524758400000,431.64,431.64,431.64,431.64],[1525363200000,428.38,428.38,428.38,428.38],[1525968000000,424.89,424.89,411.84,414.27],[1526572800000,414.27,414.27,407.69,407.69],[1527177600000,407.69,407.69,407.69,407.69],[1527782400000,407.69,407.69,402.48,402.48],[1528387200000,402.48,424.75,402.48,424.75],[1528992000000,427.95,427.95,427.95,427.95],[1529596800000,427.95,427.95,418.75,418.75],[1530201600000,418.75,418.75,412.33,412.33],[1530806400000,412.33,412.33,394.42,394.42],[1531411200000,394.42,394.42,394.42,394.42],[1532016000000,394.42,394.42,390.12,390.12],[1532620800000,390.12,390.12,390.12,390.12],[1533225600000,390.12,390.12,375.73,375.73],[1533830400000,365.92,368.17,365.92,368.17],[1534435200000,385.87,394.42,385.87,394.42],[1535040000000,394.42,415.77,394.42,415.77],[1535644800000,423.69,435.47,423.69,435.47],[1536249600000,438.65,439.27,438.65,439.27],[1536854400000,439.27,443.55,439.27,443.55],[1537459200000,443.55,448.84,443.55,448.84],[1538064000000,448.84,461.04,448.84,461.04],[1539273600000,465.87,465.87,465.87,465.87],[1539878400000,470.15,480.35,470.15,480.35],[1540483200000,482.41,492.96,482.41,492.96],[1540915200000,496.01,506.58,496.01,506.58]],'
    data_range_week=52 #要抓取的資料週數(由今天往前推幾週)
    province_name='河南'

    data_parser(parser_data,province_name,data_range_week)

    
    province_data = open('ccement_list.csv', "r")
    lines = province_data.readlines()
    province_data.close()
    for i in range(len(lines)):
        Provincename=lines[i].split(',')[0]
        ProvinceId=lines[i].split(',')[1].strip('\n')
        print ('province_name :'+Provincename)
        print ('province_id :'+ProvinceId)
    
if __name__ == "__main__":
    main()